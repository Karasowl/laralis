# Database Schema - Version 2
**Date:** 2025-11-02
**Migration:** Up to migration 45 (add_discount_system)
**Status:** Current Production Schema
**Previous Version:** [v1 (2025-10-21)](SCHEMA-v1-2025-10-21.md)

---

## Overview

This document contains the complete database schema for the Laralis dental management application. The schema follows a multi-tenant architecture with workspaces and clinics as the primary organizational units.

**What's New in v2:**
- âœ… Global discount configuration at clinic level
- âœ… Individual service discounts in tariffs
- âœ… Support for percentage and fixed-amount discounts
- âœ… Final price with discount calculation

---

## Core Architecture

### Multi-Tenancy Hierarchy
```
auth.users (Supabase Auth)
    â†“
workspaces (Organizations/Companies)
    â†“
clinics (Individual dental offices)
    â†“
patients, treatments, expenses, etc.
```

---

## Tables Reference

### ğŸ¢ Organization & Multi-Tenancy

#### `workspaces`
Root organizational entity for multi-tenant setup.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| name | varchar | NOT NULL | Workspace name |
| slug | varchar | NOT NULL, UNIQUE | URL-friendly identifier |
| description | text | | Workspace description |
| owner_id | uuid | FK â†’ auth.users | Workspace owner |
| logo_url | text | | Logo URL |
| settings | jsonb | DEFAULT '{}' | Custom settings |
| max_clinics | integer | DEFAULT 3 | Max clinics allowed |
| max_users | integer | DEFAULT 5 | Max users allowed |
| is_active | boolean | DEFAULT true | Active status |
| onboarding_completed | boolean | DEFAULT false | Onboarding status |
| onboarding_step | integer | DEFAULT 0 | Current onboarding step |
| subscription_status | varchar | DEFAULT 'trial' | Subscription tier |
| subscription_ends_at | timestamptz | | Subscription end date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Last update timestamp |

#### `clinics`
Individual dental offices within a workspace.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| workspace_id | uuid | FK â†’ workspaces | Parent workspace |
| org_id | uuid | FK â†’ organizations | Organization (legacy) |
| name | text | NOT NULL | Clinic name |
| address | text | | Physical address |
| phone | varchar | | Contact phone |
| email | varchar | | Contact email |
| is_active | boolean | DEFAULT true | Active status |
| **global_discount_config** | **jsonb** | **DEFAULT see below** | **ğŸ†• Global discount configuration** |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

**ğŸ†• global_discount_config structure:**
```json
{
  "enabled": false,
  "type": "percentage",  // "percentage" | "fixed"
  "value": 0
}
```

**Triggers:**
- `after_clinic_insert` â†’ Creates default patient_sources and custom_categories

#### `organizations`
Legacy organizational entity (deprecated, use workspaces).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| name | text | NOT NULL | Organization name |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

---

### ğŸ‘¥ Users & Access Control

*(No changes - see v1 for full table definitions)*

- `workspace_users` - Links users to workspaces with roles
- `workspace_members` - Enhanced workspace membership
- `clinic_users` - Links users to specific clinics
- `invitations` - Pending workspace/clinic invitations
- `role_permissions` - Role-based permission definitions

---

### ğŸ¥ Clinical Operations

#### `patients`
*(No changes - see v1 for full definition)*

#### `treatments`
Individual treatment/appointment records.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK â†’ clinics, NOT NULL | Owning clinic |
| patient_id | uuid | FK â†’ patients, NOT NULL | Patient |
| service_id | uuid | FK â†’ services, NOT NULL | Service performed |
| treatment_date | date | NOT NULL, DEFAULT CURRENT_DATE | Treatment date |
| treatment_time | time | | Treatment time |
| status | varchar | DEFAULT 'scheduled' | Status |
| tooth_number | varchar | | Tooth identifier |
| notes | text | | Treatment notes |
| minutes | integer | NOT NULL, DEFAULT 30 | Duration in minutes |
| fixed_cost_per_minute_cents | bigint | NOT NULL, DEFAULT 0 | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL, DEFAULT 0 | Variable cost snapshot |
| margin_pct | numeric | NOT NULL, DEFAULT 30 | Margin percentage snapshot |
| price_cents | bigint | NOT NULL, DEFAULT 0 | Final price in cents |
| tariff_version | integer | | Tariff version used |
| discount_pct | numeric | DEFAULT 0 | Discount percentage |
| discount_reason | text | | Discount justification |
| is_paid | boolean | DEFAULT false | Payment status |
| payment_method | varchar | | Payment method |
| payment_date | date | | Payment date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**Note:** Treatments store immutable cost snapshots to preserve historical pricing.

#### `services`
Service/procedure catalog.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK â†’ clinics, NOT NULL | Owning clinic |
| name | varchar | NOT NULL | Service name |
| description | text | | Service description |
| category | varchar | | Service category |
| est_minutes | integer | NOT NULL, DEFAULT 60 | Estimated duration |
| fixed_cost_per_minute_cents | bigint | DEFAULT 0 | Fixed cost per minute |
| variable_cost_cents | bigint | DEFAULT 0 | Variable cost total |
| margin_pct | numeric | DEFAULT 30.00 | Target margin percentage |
| price_cents | bigint | NOT NULL | Current price in cents |
| is_active | boolean | DEFAULT true | Active status |
| active | boolean | DEFAULT true | Active status (duplicate) |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `service_supplies`
Service recipes linking services to required supplies.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| service_id | uuid | FK â†’ services, NOT NULL | Service |
| supply_id | uuid | FK â†’ supplies, NOT NULL | Supply |
| qty | numeric | NOT NULL, DEFAULT 1 | Quantity required |
| unit_cost_cents | integer | | Unit cost snapshot |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `tariffs`
Historical service pricing versions with discount support.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK â†’ clinics, NOT NULL | Owning clinic |
| service_id | uuid | FK â†’ services, NOT NULL | Service |
| version | integer | NOT NULL, DEFAULT 1 | Version number |
| valid_from | date | NOT NULL | Start date |
| valid_until | date | | End date |
| fixed_cost_per_minute_cents | bigint | NOT NULL | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL | Variable cost snapshot |
| margin_pct | numeric | NOT NULL | Margin percentage |
| price_cents | bigint | NOT NULL | Calculated price (before discount) |
| rounded_price_cents | bigint | NOT NULL | Rounded price (before discount) |
| **discount_type** | **varchar(20)** | **DEFAULT 'none', CHECK** | **ğŸ†• Discount type: none, percentage, fixed** |
| **discount_value** | **numeric(10,2)** | **DEFAULT 0, CHECK >= 0** | **ğŸ†• Discount value (% or cents)** |
| **discount_reason** | **text** | | **ğŸ†• Optional discount description** |
| **final_price_with_discount_cents** | **integer** | | **ğŸ†• Final price after discount** |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**ğŸ†• Discount Types:**
- `none` - No discount applied
- `percentage` - Percentage discount (0-100)
- `fixed` - Fixed amount discount in cents

**ğŸ†• Discount Priority:**
1. Individual tariff discount (if set)
2. Global clinic discount (if enabled)
3. No discount

**Indexes:**
- `idx_tariffs_discount_type` - For querying tariffs with active discounts

---

### ğŸ’° Financial Management

#### `expenses`
*(No changes - see v1 for full definition)*

#### `fixed_costs`
*(No changes - see v1 for full definition)*

---

### ğŸ“¦ Inventory Management

#### `supplies`
*(No changes - see v1 for full definition)*

#### `assets`
*(No changes - see v1 for full definition)*

---

### ğŸ“Š Marketing & Analytics

#### `patient_sources`
*(No changes - see v1 for full definition)*

#### `marketing_campaigns`
*(No changes - see v1 for full definition)*

#### `marketing_campaign_status_history`
*(No changes - see v1 for full definition)*

---

### ğŸ·ï¸ Categories & Taxonomies

*(No changes - see v1 for full definitions)*

- `category_types` - Category type definitions
- `custom_categories` - Clinic-specific category instances
- `categories` - Generic category table

---

### âš™ï¸ Configuration

#### `settings_time`
*(No changes - see v1 for full definition)*

---

### ğŸ“ Activity & Audit

#### `workspace_activity`
*(No changes - see v1 for full definition)*

---

### ğŸ” Authentication & Verification

#### `verification_codes`
*(No changes - see v1 for full definition)*

---

### ğŸ—‘ï¸ Backup & Legacy Tables

#### `_backup_patient_sources`
*(No changes - see v1 for full definition)*

---

## ğŸ†• New Database Functions (Migration 45)

### `calculate_discounted_price()`
Calculates final price after applying discount.

**Signature:**
```sql
calculate_discounted_price(
  base_price_cents INTEGER,
  discount_type VARCHAR(20),
  discount_value NUMERIC(10,2)
) RETURNS INTEGER
```

**Logic:**
- If `discount_type = 'none'` or `discount_value = 0` â†’ return `base_price_cents`
- If `discount_type = 'percentage'` â†’ `discount = base_price * (value / 100)`
- If `discount_type = 'fixed'` â†’ `discount = value`
- Returns `base_price - discount` (never negative)

**Example Usage:**
```sql
SELECT calculate_discounted_price(10000, 'percentage', 10);  -- Returns 9000 (10% off $100)
SELECT calculate_discounted_price(10000, 'fixed', 1000);     -- Returns 9000 ($10 off $100)
SELECT calculate_discounted_price(10000, 'none', 0);         -- Returns 10000 (no discount)
```

---

## Key Relationships

### Multi-Tenancy Flow
```
auth.users
  â†’ workspace_users â†’ workspaces
  â†’ clinics
  â†’ [patients, treatments, expenses, etc.]
```

### Financial Calculations (ğŸ†• Updated with Discounts)
```
services + service_supplies â†’ variable_cost_cents
settings_time â†’ fixed_cost_per_minute_cents
services (margin_pct) â†’ price_cents
ğŸ†• price_cents + discount â†’ final_price_with_discount_cents
```

### Discount Application Flow (ğŸ†• New)
```
tariffs.discount_type = 'none'?
  â”œâ”€ YES â†’ Check clinics.global_discount_config.enabled?
  â”‚         â”œâ”€ YES â†’ Apply global discount
  â”‚         â””â”€ NO â†’ No discount
  â””â”€ NO â†’ Apply tariff discount (overrides global)
```

### Marketing Attribution
```
patient_sources â† patients â†’ marketing_campaigns
patients â†’ treatments (revenue)
```

---

## Important Business Rules

### 1. Money Storage
- **ALL** monetary values stored as `bigint` in **cents**
- Never use float/decimal for money storage
- Convert to currency format only in UI layer

### 2. Immutable Treatment Snapshots
Treatments store point-in-time snapshots of:
- `fixed_cost_per_minute_cents`
- `variable_cost_cents`
- `margin_pct`
- `price_cents`

These values NEVER change even if service prices change later.

### 3. Service Pricing Formula (ğŸ†• Updated)
```
variable_cost = SUM(service_supplies.qty * supply.cost_per_portion_cents)
time_cost = fixed_cost_per_minute_cents * est_minutes
total_cost = variable_cost + time_cost
price = total_cost * (1 + margin_pct/100)
rounded_price = round_to_nearest(price, round_to)

ğŸ†• Discount Application:
if tariff.discount_type != 'none':
  discount = calculate_discount(rounded_price, tariff.discount_type, tariff.discount_value)
else if clinic.global_discount_config.enabled:
  discount = calculate_discount(rounded_price, clinic.discount_type, clinic.discount_value)
else:
  discount = 0

final_price = rounded_price - discount
```

### 4. ğŸ†• Discount Business Rules

**Priority:**
1. **Individual tariff discount** overrides global discount
2. **Global clinic discount** applies if no individual discount
3. **No discount** if neither is configured

**Validation:**
- Percentage discounts: 0-100%
- Fixed discounts: 0 to rounded_price_cents (cannot exceed price)
- Final price never goes below 0

**When to Apply:**
- Discounts apply at **tariff level** (price catalog)
- Applied **after margin** is calculated
- **Before** creating treatment (snapshot includes discounted price)

### 5. RLS (Row Level Security)
- All tables with `clinic_id` have RLS policies
- Users can only access data from clinics they belong to
- Workspace owners have access to all clinics in their workspace

### 6. Auto-Created Data
When a new clinic is created, these are auto-created:
- Default patient_sources (7 sources)
- Default custom_categories (3 service categories)

---

## Recent Changes (Migration 45)

### Added Columns

**`clinics` table:**
- `global_discount_config` (jsonb) - Global discount configuration

**`tariffs` table:**
- `discount_type` (varchar) - Type of discount
- `discount_value` (numeric) - Discount value
- `discount_reason` (text) - Optional description
- `final_price_with_discount_cents` (integer) - Final price after discount

### Added Functions
- `calculate_discounted_price()` - Discount calculation helper

### Added Indexes
- `idx_tariffs_discount_type` - Performance index for discount queries

### Data Migration
- Set `final_price_with_discount_cents = rounded_price_cents` for existing tariffs

---

## Schema Version History

| Version | Date | Migration | Description |
|---------|------|-----------|-------------|
| v1 | 2025-10-21 | 41 | Initial schema documentation |
| **v2** | **2025-11-02** | **45** | **ğŸ†• Added discount system (global + individual)** |

---

## Notes

- This schema follows **strict separation** between configuration tables (`settings_time`, `fixed_costs`) and transactional tables (`treatments`, `expenses`)
- The category system is flexible and supports multiple entity types through `category_types` and `custom_categories`
- Marketing attribution is tracked through `patient_sources`, `marketing_campaigns`, and patient foreign keys
- All timestamps use `timestamptz` for proper timezone handling
- **ğŸ†• Discount system supports both clinic-wide and service-specific discounts with type flexibility (percentage or fixed amount)**
