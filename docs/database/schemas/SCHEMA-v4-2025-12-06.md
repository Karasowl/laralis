# Database Schema - Version 4
**Date:** 2025-12-06
**Migration:** Up to migration 54 (create_ai_chat_tables)
**Status:** Current Production Schema
**Previous Version:** [v3 (2025-11-17)](SCHEMA-v3-2025-11-17.md)

---

## Overview

This document contains the complete database schema for the Laralis dental management application. The schema follows a multi-tenant architecture with workspaces and clinics as the primary organizational units.

**What's New in v4:**
- ‚úÖ **AI Assistant Tables**: New tables for Lara AI conversation persistence
- ‚úÖ `action_logs` - Audit trail of AI-executed actions
- ‚úÖ `clinic_google_calendar` - Google Calendar OAuth integration per clinic
- ‚úÖ `chat_sessions` - Conversation session metadata
- ‚úÖ `chat_messages` - Individual messages within sessions
- ‚úÖ `ai_feedback` - User feedback on AI responses
- ‚úÖ `treatments.google_event_id` - New column for calendar sync

**What was New in v3:**
- ‚ö†Ô∏è **BREAKING**: `tariffs` table is now **DEPRECATED** (kept for audit only)
- ‚úÖ **Services table is the pricing catalog**: All discount fields moved to `services`
- ‚úÖ `services.price_cents` is now the **single source of truth** for final patient price
- ‚úÖ Simplified architecture: `services` ‚Üí `treatments` (no tariffs in between)
- ‚úÖ Faster queries: -50% queries for pricing operations

---

## Core Architecture

### Multi-Tenancy Hierarchy
```
auth.users (Supabase Auth)
    ‚Üì
workspaces (Organizations/Companies)
    ‚Üì
clinics (Individual dental offices)
    ‚Üì
patients, treatments, expenses, etc.
```

### üÜï Pricing Architecture (v3)

**Simplified Flow**:
```
services (catalog WITH pricing and discounts)
    ‚Üì
treatments (immutable snapshots)
```

**KEY CHANGE**: The `tariffs` table is **no longer used** for active pricing. Services table now contains all pricing information including discounts.

---

## Tables Reference

### üè¢ Organization & Multi-Tenancy

#### `workspaces`
Root organizational entity for multi-tenant setup.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| name | varchar | NOT NULL | Workspace name |
| slug | varchar | NOT NULL, UNIQUE | URL-friendly identifier |
| description | text | | Workspace description |
| owner_id | uuid | FK ‚Üí auth.users | Workspace owner |
| logo_url | text | | Logo URL |
| settings | jsonb | DEFAULT '{}' | Custom settings |
| max_clinics | integer | DEFAULT 3 | Max clinics allowed |
| max_users | integer | DEFAULT 5 | Max users allowed |
| is_active | boolean | DEFAULT true | Active status |
| onboarding_completed | boolean | DEFAULT false | Onboarding status |
| onboarding_step | integer | DEFAULT 0 | Current onboarding step |
| subscription_status | varchar | DEFAULT 'trial' | Subscription tier |
| subscription_ends_at | timestamptz | | Subscription end date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Last update timestamp |

#### `clinics`
Individual dental offices within a workspace.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| workspace_id | uuid | FK ‚Üí workspaces | Parent workspace |
| org_id | uuid | FK ‚Üí organizations | Organization (legacy) |
| name | text | NOT NULL | Clinic name |
| address | text | | Physical address |
| phone | varchar | | Contact phone |
| email | varchar | | Contact email |
| is_active | boolean | DEFAULT true | Active status |
| global_discount_config | jsonb | DEFAULT see below | Global discount configuration |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

**global_discount_config structure:**
```json
{
  "enabled": false,
  "type": "percentage",  // "percentage" | "fixed"
  "value": 0
}
```

**Triggers:**
- `after_clinic_insert` ‚Üí Creates default patient_sources and custom_categories

#### `organizations`
Legacy organizational entity (deprecated, use workspaces).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| name | text | NOT NULL | Organization name |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

---

### üë• Users & Access Control

*(No changes from v2 - see v2 for full table definitions)*

- `workspace_users` - Links users to workspaces with roles
- `workspace_members` - Enhanced workspace membership
- `clinic_users` - Links users to specific clinics
- `invitations` - Pending workspace/clinic invitations
- `role_permissions` - Role-based permission definitions

---

### üè• Clinical Operations

#### `patients`
*(No changes from v2 - see v2 for full definition)*

#### `treatments`
Individual treatment/appointment records.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| patient_id | uuid | FK ‚Üí patients, NOT NULL | Patient |
| service_id | uuid | FK ‚Üí services, NOT NULL | Service performed |
| treatment_date | date | NOT NULL, DEFAULT CURRENT_DATE | Treatment date |
| treatment_time | time | | Treatment time |
| status | varchar | DEFAULT 'scheduled' | Status |
| tooth_number | varchar | | Tooth identifier |
| notes | text | | Treatment notes |
| minutes | integer | NOT NULL, DEFAULT 30 | Duration in minutes |
| fixed_cost_per_minute_cents | bigint | NOT NULL, DEFAULT 0 | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL, DEFAULT 0 | Variable cost snapshot |
| margin_pct | numeric | NOT NULL, DEFAULT 30 | Margin percentage snapshot |
| price_cents | bigint | NOT NULL, DEFAULT 0 | Final price in cents (what patient paid) |
| tariff_version | integer | | **üóëÔ∏è Deprecated**: No longer used (kept for legacy data) |
| discount_pct | numeric | DEFAULT 0 | **üóëÔ∏è Deprecated**: Use service snapshot instead |
| discount_reason | text | | **üóëÔ∏è Deprecated**: Use service snapshot instead |
| is_paid | boolean | DEFAULT false | Payment status |
| payment_method | varchar | | Payment method |
| payment_date | date | | Payment date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**Important Notes:**
- Treatments store **immutable snapshots** at the time of treatment
- The `tariff_version` field is deprecated but kept for backward compatibility
- `price_cents` is copied from `services.price_cents` at treatment creation time

#### `services` üÜï Updated in v3
Service/procedure catalog **WITH INTEGRATED PRICING** (no separate tariffs table).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| name | varchar | NOT NULL | Service name |
| description | text | | Service description |
| category | varchar | | Service category |
| est_minutes | integer | NOT NULL, DEFAULT 60 | Estimated duration |
| fixed_cost_per_minute_cents | bigint | DEFAULT 0 | Fixed cost per minute |
| variable_cost_cents | bigint | DEFAULT 0 | Variable cost total |
| margin_pct | numeric | DEFAULT 30.00 | Target margin percentage |
| **price_cents** | **bigint** | **NOT NULL** | **üÜï SINGLE SOURCE OF TRUTH: Final price patient pays (with discount applied)** |
| **discount_type** | **varchar(20)** | **DEFAULT 'none'** | **üÜï Discount type: none, percentage, fixed** |
| **discount_value** | **numeric(10,2)** | **DEFAULT 0** | **üÜï Discount value (% or cents depending on type)** |
| **discount_reason** | **text** | | **üÜï Optional discount description/justification** |
| is_active | boolean | DEFAULT true | Active status |
| active | boolean | DEFAULT true | Active status (duplicate) |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**üÜï Key Changes in v3:**
- `price_cents` now stores the **final discounted price** (what the patient actually pays)
- Discount fields moved here from deprecated `tariffs` table
- This table is now the complete pricing catalog

**Discount Types:**
- `none` - No discount (price_cents = calculated price)
- `percentage` - Percentage discount (0-100%)
- `fixed` - Fixed amount discount in cents

**Pricing Calculation Flow:**
```
1. base_cost = variable_cost + (fixed_cost_per_minute * est_minutes)
2. price_with_margin = base_cost * (1 + margin_pct/100)
3. apply_discount(price_with_margin, discount_type, discount_value)
4. price_cents = final_discounted_price  ‚Üê Stored in DB
```

**Indexes:**
- `idx_services_discount_type` - For querying services with active discounts

#### `service_supplies`
Service recipes linking services to required supplies.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| service_id | uuid | FK ‚Üí services, NOT NULL | Service |
| supply_id | uuid | FK ‚Üí supplies, NOT NULL | Supply |
| qty | numeric | NOT NULL, DEFAULT 1 | Quantity required |
| unit_cost_cents | integer | | Unit cost snapshot |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `tariffs` ‚ö†Ô∏è **DEPRECATED in v3**
**STATUS**: ‚ö†Ô∏è **THIS TABLE IS DEPRECATED AND NO LONGER USED**

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| service_id | uuid | FK ‚Üí services, NOT NULL | Service |
| version | integer | NOT NULL, DEFAULT 1 | Version number |
| valid_from | date | NOT NULL | Start date |
| valid_until | date | | End date |
| fixed_cost_per_minute_cents | bigint | NOT NULL | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL | Variable cost snapshot |
| margin_pct | numeric | NOT NULL | Margin percentage |
| price_cents | bigint | NOT NULL | Calculated price (before discount) |
| rounded_price_cents | bigint | NOT NULL | Rounded price (before discount) |
| discount_type | varchar(20) | DEFAULT 'none', CHECK | Discount type: none, percentage, fixed |
| discount_value | numeric(10,2) | DEFAULT 0, CHECK >= 0 | Discount value (% or cents) |
| discount_reason | text | | Optional discount description |
| final_price_with_discount_cents | integer | | Final price after discount |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**‚ö†Ô∏è IMPORTANT DEPRECATION NOTES:**
- **DO NOT USE THIS TABLE** in new code
- **DO NOT INSERT** new tariff records
- **DO NOT QUERY** this table for active pricing
- **USE `services` table instead** for all pricing operations
- This table is **kept for:**
  - Historical audit purposes
  - Fiscal compliance (tax records)
  - Legacy data preservation
- **RLS policies**: Read-only access for audit queries only

**Migration Note**: All active tariff data was migrated to `services` table in migration 46.

---

### üí∞ Financial Management

#### `expenses`
*(No changes from v2 - see v2 for full definition)*

#### `fixed_costs`
*(No changes from v2 - see v2 for full definition)*

---

### üì¶ Inventory Management

#### `supplies`
*(No changes from v2 - see v2 for full definition)*

#### `assets`
*(No changes from v2 - see v2 for full definition)*

---

### üìä Marketing & Analytics

#### `patient_sources`
*(No changes from v2 - see v2 for full definition)*

#### `marketing_campaigns`
*(No changes from v2 - see v2 for full definition)*

#### `marketing_campaign_status_history`
*(No changes from v2 - see v2 for full definition)*

---

### üè∑Ô∏è Categories & Taxonomies

*(No changes from v2 - see v2 for full definitions)*

- `category_types` - Category type definitions
- `custom_categories` - Clinic-specific category instances
- `categories` - Generic category table

---

### ‚öôÔ∏è Configuration

#### `settings_time`
*(No changes from v2 - see v2 for full definition)*

---

### üìù Activity & Audit

#### `workspace_activity`
*(No changes from v2 - see v2 for full definition)*

---

### üîê Authentication & Verification

#### `verification_codes`
*(No changes from v2 - see v2 for full definition)*

---

### üóëÔ∏è Backup & Legacy Tables

#### `_backup_patient_sources`
*(No changes from v2 - see v2 for full definition)*

---

## Database Functions

### `calculate_discounted_price()` (Migration 45)
Calculates final price after applying discount.

**Signature:**
```sql
calculate_discounted_price(
  base_price_cents INTEGER,
  discount_type VARCHAR(20),
  discount_value NUMERIC(10,2)
) RETURNS INTEGER
```

**Logic:**
- If `discount_type = 'none'` or `discount_value = 0` ‚Üí return `base_price_cents`
- If `discount_type = 'percentage'` ‚Üí `discount = base_price * (value / 100)`
- If `discount_type = 'fixed'` ‚Üí `discount = value`
- Returns `base_price - discount` (never negative)

**Note**: This function is still available but is now used in application code rather than in tariffs table triggers.

---

## Key Relationships

### Multi-Tenancy Flow
```
auth.users
  ‚Üí workspace_users ‚Üí workspaces
  ‚Üí clinics
  ‚Üí [patients, treatments, expenses, etc.]
```

### üÜï Pricing Flow (v3 - Simplified)
```
services (WITH price_cents + discounts)
    ‚Üì
treatments (immutable snapshots)
```

**Key Difference from v2:**
- ‚ùå **v2**: `services` ‚Üí `tariffs` (versioned prices) ‚Üí `treatments`
- ‚úÖ **v3**: `services` (single current price) ‚Üí `treatments`

**Benefits:**
- -50% queries for pricing operations
- No version management complexity
- Single source of truth: `services.price_cents`

### Discount Application Flow (üÜï Simplified in v3)
```
Individual service discount?
  ‚îú‚îÄ YES ‚Üí Use service.discount_type/value
  ‚îî‚îÄ NO ‚Üí Check clinics.global_discount_config.enabled?
            ‚îú‚îÄ YES ‚Üí Apply global discount
            ‚îî‚îÄ NO ‚Üí No discount (price_cents = base price)
```

### Marketing Attribution
```
patient_sources ‚Üê patients ‚Üí marketing_campaigns
patients ‚Üí treatments (revenue)
```

---

## Important Business Rules

### 1. Money Storage
- **ALL** monetary values stored as `bigint` in **cents**
- Never use float/decimal for money storage
- Convert to currency format only in UI layer

### 2. Immutable Treatment Snapshots
Treatments store point-in-time snapshots of:
- `fixed_cost_per_minute_cents`
- `variable_cost_cents`
- `margin_pct`
- `price_cents` (copied from `services.price_cents` at treatment time)

These values **NEVER change** even if service prices change later.

### 3. üÜï Service Pricing Formula (v3 - Updated)

**Step-by-step calculation**:
```javascript
// 1. Calculate variable cost from supplies
variable_cost = SUM(service_supplies.qty * supply.cost_per_portion_cents)

// 2. Calculate time-based fixed cost
time_cost = fixed_cost_per_minute_cents * est_minutes

// 3. Total cost
total_cost = variable_cost + time_cost

// 4. Apply margin (MARKUP over cost)
price_before_discount = total_cost * (1 + margin_pct/100)

// 5. Apply discount if configured
if (discount_type === 'percentage') {
  discount_amount = price_before_discount * (discount_value / 100)
} else if (discount_type === 'fixed') {
  discount_amount = discount_value * 100  // convert to cents
} else {
  discount_amount = 0
}

// 6. Final price stored in services.price_cents
services.price_cents = price_before_discount - discount_amount  // ‚Üê SINGLE SOURCE OF TRUTH
```

**Critical**: `services.price_cents` is the **final price patient pays**. This is what gets copied to `treatments.price_cents`.

### 4. üÜï Discount Business Rules (v3 - Simplified)

**Priority:**
1. **Individual service discount** (services.discount_type/value) takes precedence
2. **Global clinic discount** (clinics.global_discount_config) applies if no individual discount
3. **No discount** if neither is configured

**Validation:**
- Percentage discounts: 0-100%
- Fixed discounts: 0 to price_before_discount (cannot exceed base price)
- Final price never goes below 0

**When Discount is Applied:**
- Calculated and applied **before storing** in `services.price_cents`
- `price_cents` always contains the **final discounted price**
- No need to recalculate discount at treatment time

### 5. RLS (Row Level Security)
- All tables with `clinic_id` have RLS policies
- Users can only access data from clinics they belong to
- Workspace owners have access to all clinics in their workspace
- **Special**: `tariffs` table is **read-only** via RLS (deprecated table)

### 6. Auto-Created Data
When a new clinic is created, these are auto-created:
- Default patient_sources (7 sources)
- Default custom_categories (3 service categories)

### 7. üÜï Historical Price Queries (v3)

**To get historical pricing data:**

```sql
-- ‚ùå WRONG (v2 way - querying tariffs)
SELECT * FROM tariffs WHERE service_id = $1 ORDER BY version DESC;

-- ‚úÖ CORRECT (v3 way - query treatments)
SELECT DISTINCT price_cents, created_at, service_id
FROM treatments
WHERE service_id = $1
ORDER BY created_at DESC;
```

**Rationale**: Treatments contain immutable snapshots of the price at treatment time. This gives you accurate historical pricing without needing a separate versioning table.

---

## Recent Changes (Migration 46)

### Added Columns

**`services` table** (moved from tariffs):
- `discount_type` (varchar) - Type of discount: none, percentage, fixed
- `discount_value` (numeric) - Discount amount
- `discount_reason` (text) - Optional description

**`services` table** (semantic change):
- `price_cents` (bigint) - **Now stores final discounted price** (was base price in v2)

### Deprecated Table

**`tariffs`:**
- Marked as **DEPRECATED** via SQL comment
- RLS policies changed to **read-only**
- No longer included in export/import system
- UI page redirects to `/services`

### Data Migration

**Migration 46 executed**:
```sql
-- Migrated all active tariffs to services
UPDATE services SET
  discount_type = tariffs.discount_type,
  discount_value = tariffs.discount_value,
  discount_reason = tariffs.discount_reason,
  price_cents = tariffs.final_price_with_discount_cents  -- ‚Üê Key change
FROM tariffs
WHERE tariffs.service_id = services.id AND tariffs.is_active = true;

-- Marked tariffs as deprecated
COMMENT ON TABLE tariffs IS 'DEPRECATED: Use services table for pricing...';
```

### Added Indexes
- `idx_services_discount_type` - Performance index for discount queries

---

## Schema Version History

| Version | Date | Migration | Description |
|---------|------|-----------|-------------|
| v1 | 2025-10-21 | 41 | Initial schema documentation |
| v2 | 2025-11-02 | 45 | Added discount system (tariffs + clinics) |
| **v3** | **2025-11-17** | **46** | **‚ö†Ô∏è Deprecated tariffs, moved discounts to services** |

---

## Migration Guide: v2 ‚Üí v3

### For Developers

#### ‚úÖ DO: Use services table for pricing
```typescript
// Get service price
const service = await supabase
  .from('services')
  .select('*')
  .eq('id', serviceId)
  .single()

const finalPrice = service.price_cents  // Already includes discount
```

#### ‚ùå DON'T: Query tariffs table
```typescript
// ‚ùå NEVER DO THIS IN v3
const tariff = await supabase
  .from('tariffs')
  .select('*')
  .eq('service_id', serviceId)
  .eq('is_active', true)
```

#### ‚úÖ DO: Update service pricing directly
```typescript
// Update price with discount
await supabase
  .from('services')
  .update({
    price_cents: calculateServicePrice(...),  // final price
    discount_type: 'percentage',
    discount_value: 10,
    discount_reason: 'Frequent customer'
  })
  .eq('id', serviceId)
```

#### ‚úÖ DO: Create treatments with service snapshot
```typescript
// Create treatment
await supabase
  .from('treatments')
  .insert({
    service_id: service.id,
    price_cents: service.price_cents,  // Copy final price
    margin_pct: service.margin_pct,
    variable_cost_cents: service.variable_cost_cents,
    // NO tariff_version field needed
  })
```

### For AI Assistant

#### ‚úÖ DO: Query services for pricing
```typescript
const snapshot = await supabase
  .from('services')
  .select('price_cents, discount_type, discount_value')
  .eq('clinic_id', clinicId)

// price_cents is ready to use (final price with discount)
```

#### ‚ùå DON'T: Mention "tariffs" in responses
```typescript
// ‚ùå WRONG
"La tarifa del servicio 'Limpieza' es $500..."

// ‚úÖ CORRECT
"El servicio 'Limpieza' tiene un precio de $500..."
```

---

## ü§ñ AI Assistant & Integrations (v4)

### `action_logs`
Audit trail of all actions executed by Lara AI assistant via Actions System.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Clinic reference |
| user_id | uuid | FK ‚Üí auth.users | User who triggered action |
| action_type | text | NOT NULL, CHECK | Type of action executed |
| success | boolean | NOT NULL | Whether action succeeded |
| params | jsonb | NOT NULL | Action parameters |
| result | jsonb | | Action result (before/after state) |
| error_code | text | | Error code if failed |
| error_message | text | | Error message if failed |
| error_details | jsonb | | Additional error details |
| dry_run | boolean | DEFAULT false | True if simulation only |
| executed_at | timestamptz | DEFAULT now() | When action was executed |
| created_at | timestamptz | DEFAULT now() | Record creation timestamp |

**action_type values:** `update_service_price`, `adjust_service_margin`, `simulate_price_change`, `create_expense`, `update_time_settings`

**Indexes:**
- `idx_action_logs_clinic_id` - By clinic
- `idx_action_logs_user_id` - By user
- `idx_action_logs_action_type` - By action type
- `idx_action_logs_executed_at` - By execution time (DESC)
- `idx_action_logs_clinic_executed` - Composite for clinic + time range
- `idx_action_logs_success` - By success status

**RLS:** Users can SELECT/INSERT for their clinic memberships only. No UPDATE/DELETE (immutable logs).

---

### `clinic_google_calendar`
Google Calendar OAuth tokens per clinic for sync integration.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL, UNIQUE | One calendar per clinic |
| calendar_id | text | NOT NULL | Google Calendar ID |
| access_token | text | NOT NULL | OAuth access token |
| refresh_token | text | NOT NULL | OAuth refresh token |
| token_expires_at | timestamptz | NOT NULL | Access token expiry |
| connected_email | text | | Google account email |
| is_active | boolean | DEFAULT true | Whether sync is enabled |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Last update (via trigger) |

**RLS:** Clinic members can SELECT. Owners/admins can INSERT/UPDATE/DELETE.

---

### `chat_sessions`
Stores conversation sessions with Lara AI assistant.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Clinic reference |
| user_id | uuid | FK ‚Üí auth.users, NOT NULL | User who started session |
| mode | varchar(10) | NOT NULL, CHECK | 'entry' or 'query' |
| title | varchar(255) | | Session title (auto-generated) |
| started_at | timestamptz | DEFAULT now() | Session start time |
| ended_at | timestamptz | | Session end time (NULL if active) |
| last_message_at | timestamptz | DEFAULT now() | Last message timestamp |
| message_count | int | DEFAULT 0 | Total messages in session |
| is_archived | boolean | DEFAULT false | Soft delete flag |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Last update timestamp |

**mode values:** `entry` (data entry mode), `query` (analytics/question mode)

**Indexes:**
- `idx_chat_sessions_clinic_id` - By clinic
- `idx_chat_sessions_user_id` - By user
- `idx_chat_sessions_last_message` - By last message (DESC)
- `idx_chat_sessions_active` - Active sessions only

**RLS:** Users can only access their own sessions.

**Triggers:** `trigger_update_chat_session_stats` - Updates message_count and last_message_at on new message.

---

### `chat_messages`
Individual messages within chat sessions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| session_id | uuid | FK ‚Üí chat_sessions, NOT NULL | Parent session |
| role | varchar(10) | NOT NULL, CHECK | 'user', 'assistant', or 'system' |
| content | text | NOT NULL | Message text content |
| thinking_process | text | | Kimi K2 thinking process |
| model_used | varchar(50) | | LLM model identifier |
| tokens_used | int | | Approximate token count |
| action_suggested | jsonb | | ActionSuggestion object |
| action_executed | boolean | DEFAULT false | Whether action was executed |
| action_result | jsonb | | ActionResult if executed |
| entity_type | varchar(50) | | For entry mode entities |
| extracted_data | jsonb | | Extracted form data |
| audio_duration_ms | int | | Voice message duration |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

**Indexes:**
- `idx_chat_messages_session_id` - By session
- `idx_chat_messages_created_at` - By session + time
- `idx_chat_messages_with_actions` - Messages with action suggestions

**RLS:** Users can access messages from their own sessions only.

**Triggers:** `trigger_auto_generate_session_title` - Auto-generates title from first user message.

---

### `ai_feedback`
User feedback on AI responses for quality improvement.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| message_id | uuid | FK ‚Üí chat_messages, NOT NULL | Message being rated |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Clinic reference |
| user_id | uuid | FK ‚Üí auth.users, NOT NULL | User giving feedback |
| rating | varchar(10) | NOT NULL, CHECK | 'positive' or 'negative' |
| comment | text | | Optional user comment |
| query_type | varchar(50) | | Category of query |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

**Indexes:**
- `idx_ai_feedback_message_id` - By message
- `idx_ai_feedback_clinic_id` - By clinic

**RLS:** Users can only access their own feedback.

---

### Column Addition: `treatments.google_event_id`
New column added to `treatments` table for Google Calendar sync.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| google_event_id | text | | Google Calendar event ID |

---

## Notes

- This schema follows **strict separation** between configuration tables (`settings_time`, `fixed_costs`) and transactional tables (`treatments`, `expenses`)
- The category system is flexible and supports multiple entity types through `category_types` and `custom_categories`
- Marketing attribution is tracked through `patient_sources`, `marketing_campaigns`, and patient foreign keys
- All timestamps use `timestamptz` for proper timezone handling
- **üÜï v3**: Simplified pricing architecture eliminates need for separate tariffs table and versioning system
- **üÜï v3**: `services.price_cents` is the **single source of truth** for current pricing
- **üÜï v3**: Historical pricing queries should use `treatments` table, not deprecated `tariffs` table
- **üÜï v4**: AI Assistant tables enable conversation persistence and action audit trails
- **üÜï v4**: Google Calendar integration allows appointment sync per clinic
- **üÜï v4**: User feedback system tracks AI response quality for improvement
