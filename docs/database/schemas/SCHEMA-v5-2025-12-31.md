# Database Schema v5

**Version:** 5
**Date:** 2025-12-31
**Previous Version:** [v4 (2025-12-06)](SCHEMA-v4-2025-12-06.md)

---

## What's New in v5

**Explicit Pending Balance System** (Migration 73):
- `treatments.pending_balance_cents` - Explicit user-marked pending balance field
- Replaces automatic `is_paid` calculation with explicit user input
- NULL = no pending balance (fully paid), >0 = pending amount in cents

---

## Changes from v4

### Modified Tables

#### `treatments` - Added pending_balance_cents

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| **pending_balance_cents** | **bigint** | **DEFAULT NULL** | **ðŸ†• Explicit pending balance marked by user. NULL = paid, >0 = pending amount** |

**New Index:**
```sql
CREATE INDEX idx_treatments_pending_balance
ON treatments(clinic_id, pending_balance_cents)
WHERE pending_balance_cents IS NOT NULL AND pending_balance_cents > 0;
```

**Business Logic Change:**
- Previously: `is_paid = false` automatically meant "pending payment"
- Now: `pending_balance_cents > 0` explicitly marks pending payments
- `is_paid` field is still available but less important for display
- Users manually mark pending balances when creating/editing treatments

---

## Full treatments Table (v5)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK â†’ clinics, NOT NULL | Owning clinic |
| patient_id | uuid | FK â†’ patients, NOT NULL | Patient |
| service_id | uuid | FK â†’ services, NOT NULL | Service performed |
| treatment_date | date | NOT NULL, DEFAULT CURRENT_DATE | Treatment date |
| treatment_time | time | | Treatment time |
| status | varchar | DEFAULT 'scheduled' | Status |
| tooth_number | varchar | | Tooth identifier |
| notes | text | | Treatment notes |
| minutes | integer | NOT NULL, DEFAULT 30 | Duration in minutes |
| fixed_cost_per_minute_cents | bigint | NOT NULL, DEFAULT 0 | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL, DEFAULT 0 | Variable cost snapshot |
| margin_pct | numeric | NOT NULL, DEFAULT 30 | Margin percentage snapshot |
| price_cents | bigint | NOT NULL, DEFAULT 0 | Final price in cents |
| tariff_version | integer | | ðŸ—‘ï¸ Deprecated |
| discount_pct | numeric | DEFAULT 0 | ðŸ—‘ï¸ Deprecated |
| discount_reason | text | | ðŸ—‘ï¸ Deprecated |
| is_paid | boolean | DEFAULT false | Legacy payment status |
| payment_method | varchar | | Payment method |
| payment_date | date | | Payment date |
| **pending_balance_cents** | **bigint** | **DEFAULT NULL** | **ðŸ†• Explicit pending balance (NULL = paid)** |
| is_refunded | boolean | DEFAULT false | Whether treatment was refunded |
| refunded_at | timestamptz | | When refund was processed |
| refund_reason | text | | Reason for refund |
| google_event_id | varchar | | Google Calendar event ID |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

---

## Migration Reference

**Migration 73:** `73_pending_balance_explicit.sql`
```sql
ALTER TABLE treatments
ADD COLUMN IF NOT EXISTS pending_balance_cents bigint DEFAULT NULL;

CREATE INDEX IF NOT EXISTS idx_treatments_pending_balance
ON treatments(clinic_id, pending_balance_cents)
WHERE pending_balance_cents IS NOT NULL AND pending_balance_cents > 0;
```

---

## Usage Notes

### Checking for Pending Balance
```typescript
// Old way (don't use for display)
const hasPendingPayment = !treatment.is_paid

// New way (use this)
const hasPendingBalance = treatment.pending_balance_cents && treatment.pending_balance_cents > 0
```

### Setting Pending Balance
```typescript
// User marks explicit pending balance (in cents)
pending_balance_cents: 50000  // $500.00 pending

// Clear pending balance (fully paid)
pending_balance_cents: null
```

### Filtering
```sql
-- Treatments with pending balance
SELECT * FROM treatments
WHERE pending_balance_cents IS NOT NULL
  AND pending_balance_cents > 0;
```

---

## All Tables (Reference to v4)

For the complete schema of all other tables, see [SCHEMA-v4-2025-12-06.md](SCHEMA-v4-2025-12-06.md).

This document only covers changes introduced in v5.
