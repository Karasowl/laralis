# Database Schema - Version 1
**Date:** 2025-10-21
**Migration:** Up to migration 41 (auto_create_clinic_categories)
**Status:** Current Production Schema

---

## Overview

This document contains the complete database schema for the Laralis dental management application. The schema follows a multi-tenant architecture with workspaces and clinics as the primary organizational units.

## Core Architecture

### Multi-Tenancy Hierarchy
```
auth.users (Supabase Auth)
    ‚Üì
workspaces (Organizations/Companies)
    ‚Üì
clinics (Individual dental offices)
    ‚Üì
patients, treatments, expenses, etc.
```

---

## Tables Reference

### üè¢ Organization & Multi-Tenancy

#### `workspaces`
Root organizational entity for multi-tenant setup.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| name | varchar | NOT NULL | Workspace name |
| slug | varchar | NOT NULL, UNIQUE | URL-friendly identifier |
| description | text | | Workspace description |
| owner_id | uuid | FK ‚Üí auth.users | Workspace owner |
| logo_url | text | | Logo URL |
| settings | jsonb | DEFAULT '{}' | Custom settings |
| max_clinics | integer | DEFAULT 3 | Max clinics allowed |
| max_users | integer | DEFAULT 5 | Max users allowed |
| is_active | boolean | DEFAULT true | Active status |
| onboarding_completed | boolean | DEFAULT false | Onboarding status |
| onboarding_step | integer | DEFAULT 0 | Current onboarding step |
| subscription_status | varchar | DEFAULT 'trial' | Subscription tier |
| subscription_ends_at | timestamptz | | Subscription end date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Last update timestamp |

#### `clinics`
Individual dental offices within a workspace.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| workspace_id | uuid | FK ‚Üí workspaces | Parent workspace |
| org_id | uuid | FK ‚Üí organizations | Organization (legacy) |
| name | text | NOT NULL | Clinic name |
| address | text | | Physical address |
| phone | varchar | | Contact phone |
| email | varchar | | Contact email |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

**Triggers:**
- `after_clinic_insert` ‚Üí Creates default patient_sources and custom_categories

#### `organizations`
Legacy organizational entity (deprecated, use workspaces).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT gen_random_uuid() | Primary key |
| name | text | NOT NULL | Organization name |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

---

### üë• Users & Access Control

#### `workspace_users`
Links users to workspaces with roles.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| workspace_id | uuid | FK ‚Üí workspaces, NOT NULL | Workspace |
| user_id | uuid | FK ‚Üí auth.users, NOT NULL | User |
| role | varchar | NOT NULL, CHECK | Role: owner, admin, member, viewer |
| permissions | jsonb | DEFAULT '{}' | Custom permissions |
| is_active | boolean | DEFAULT true | Active status |
| invited_by | uuid | FK ‚Üí auth.users | Who invited |
| joined_at | timestamptz | DEFAULT now() | Join date |
| invitation_accepted_at | timestamptz | | Acceptance date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `workspace_members`
Enhanced workspace membership with clinic-level access.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| workspace_id | uuid | FK ‚Üí workspaces, NOT NULL | Workspace |
| user_id | uuid | FK ‚Üí auth.users, NOT NULL | User |
| email | varchar | | User email |
| display_name | varchar | | Display name |
| role | varchar | NOT NULL, CHECK | Role: owner, super_admin, admin, editor, viewer |
| permissions | jsonb | DEFAULT '{}' | Custom permissions |
| allowed_clinics | uuid[] | | Array of allowed clinic IDs |
| clinic_ids | uuid[] | DEFAULT '{}' | Clinic access list |
| invitation_status | varchar | DEFAULT 'pending', CHECK | Status: pending, accepted, rejected |
| invited_at | timestamptz | DEFAULT now() | Invitation date |
| accepted_at | timestamptz | | Acceptance date |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `clinic_users`
Links users to specific clinics with roles.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Clinic |
| user_id | uuid | FK ‚Üí auth.users, NOT NULL | User |
| role | varchar | NOT NULL, CHECK | Role: admin, doctor, assistant, receptionist, viewer |
| permissions | jsonb | DEFAULT '{}' | Custom permissions |
| is_active | boolean | DEFAULT true | Active status |
| can_access_all_patients | boolean | DEFAULT false | Full patient access |
| assigned_chair | varchar | | Assigned dental chair |
| schedule | jsonb | DEFAULT '{}' | Work schedule |
| joined_at | timestamptz | DEFAULT now() | Join date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `invitations`
Pending workspace/clinic invitations.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| workspace_id | uuid | FK ‚Üí workspaces, NOT NULL | Target workspace |
| clinic_id | uuid | FK ‚Üí clinics | Target clinic (optional) |
| email | varchar | NOT NULL | Invitee email |
| role | varchar | NOT NULL | Assigned role |
| permissions | jsonb | DEFAULT '{}' | Custom permissions |
| token | varchar | NOT NULL, UNIQUE | Invitation token |
| expires_at | timestamptz | NOT NULL | Expiration date |
| invited_by | uuid | FK ‚Üí auth.users, NOT NULL | Inviter |
| accepted_at | timestamptz | | Acceptance date |
| rejected_at | timestamptz | | Rejection date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

#### `role_permissions`
Role-based permission definitions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK, DEFAULT uuid_generate_v4() | Primary key |
| role | text | NOT NULL, CHECK | Role: owner, admin, editor, viewer |
| resource_name | text | NOT NULL | Resource name |
| action_name | text | NOT NULL | Action name |
| allowed | boolean | DEFAULT false | Permission granted |
| created_at | timestamptz | DEFAULT timezone('utc', now()) | Creation timestamp |

---

### üè• Clinical Operations

#### `patients`
Patient master records.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| first_name | varchar | NOT NULL | First name |
| last_name | varchar | NOT NULL | Last name |
| email | varchar | | Email address |
| phone | varchar | | Phone number |
| birth_date | date | | Date of birth |
| gender | varchar | | Gender |
| address | text | | Street address |
| city | varchar | | City |
| state | varchar | | State/Province |
| postal_code | varchar | | Postal code |
| medical_history | text | | Medical history notes |
| allergies | text | | Known allergies |
| medications | text | | Current medications |
| emergency_contact | varchar | | Emergency contact name |
| emergency_phone | varchar | | Emergency contact phone |
| notes | text | | General notes |
| first_visit_date | date | | Date of first visit |
| acquisition_date | date | | Patient acquisition date |
| source_id | uuid | FK ‚Üí patient_sources | Acquisition source |
| referred_by_patient_id | uuid | FK ‚Üí patients | Referring patient |
| campaign_id | uuid | FK ‚Üí marketing_campaigns | Marketing campaign |
| campaign_name | varchar | | Campaign name (legacy) |
| platform_id | uuid | FK ‚Üí categories | Marketing platform |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `treatments`
Individual treatment/appointment records.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| patient_id | uuid | FK ‚Üí patients, NOT NULL | Patient |
| service_id | uuid | FK ‚Üí services, NOT NULL | Service performed |
| treatment_date | date | NOT NULL, DEFAULT CURRENT_DATE | Treatment date |
| treatment_time | time | | Treatment time |
| status | varchar | DEFAULT 'scheduled' | Status |
| tooth_number | varchar | | Tooth identifier |
| notes | text | | Treatment notes |
| minutes | integer | NOT NULL, DEFAULT 30 | Duration in minutes |
| fixed_cost_per_minute_cents | bigint | NOT NULL, DEFAULT 0 | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL, DEFAULT 0 | Variable cost snapshot |
| margin_pct | numeric | NOT NULL, DEFAULT 30 | Margin percentage snapshot |
| price_cents | bigint | NOT NULL, DEFAULT 0 | Final price in cents |
| tariff_version | integer | | Tariff version used |
| discount_pct | numeric | DEFAULT 0 | Discount percentage |
| discount_reason | text | | Discount justification |
| is_paid | boolean | DEFAULT false | Payment status |
| payment_method | varchar | | Payment method |
| payment_date | date | | Payment date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**Note:** Treatments store immutable cost snapshots to preserve historical pricing.

#### `services`
Service/procedure catalog.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| name | varchar | NOT NULL | Service name |
| description | text | | Service description |
| category | varchar | | Service category |
| est_minutes | integer | NOT NULL, DEFAULT 60 | Estimated duration |
| fixed_cost_per_minute_cents | bigint | DEFAULT 0 | Fixed cost per minute |
| variable_cost_cents | bigint | DEFAULT 0 | Variable cost total |
| margin_pct | numeric | DEFAULT 30.00 | Target margin percentage |
| price_cents | bigint | NOT NULL | Current price in cents |
| is_active | boolean | DEFAULT true | Active status |
| active | boolean | DEFAULT true | Active status (duplicate) |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `service_supplies`
Service recipes linking services to required supplies.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| service_id | uuid | FK ‚Üí services, NOT NULL | Service |
| supply_id | uuid | FK ‚Üí supplies, NOT NULL | Supply |
| qty | numeric | NOT NULL, DEFAULT 1 | Quantity required |
| unit_cost_cents | integer | | Unit cost snapshot |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `tariffs`
Historical service pricing versions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| service_id | uuid | FK ‚Üí services, NOT NULL | Service |
| version | integer | NOT NULL, DEFAULT 1 | Version number |
| valid_from | date | NOT NULL | Start date |
| valid_until | date | | End date |
| fixed_cost_per_minute_cents | bigint | NOT NULL | Fixed cost snapshot |
| variable_cost_cents | bigint | NOT NULL | Variable cost snapshot |
| margin_pct | numeric | NOT NULL | Margin percentage |
| price_cents | bigint | NOT NULL | Calculated price |
| rounded_price_cents | bigint | NOT NULL | Rounded price |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

---

### üí∞ Financial Management

#### `expenses`
Expense tracking.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| expense_date | date | NOT NULL | Expense date |
| category_id | uuid | FK ‚Üí categories, NOT NULL | Expense category |
| category | varchar | NOT NULL | Category name (denormalized) |
| subcategory | varchar | | Subcategory name |
| description | text | | Expense description |
| amount_cents | bigint | NOT NULL | Amount in cents |
| vendor | varchar | | Vendor name |
| invoice_number | varchar | | Invoice reference |
| is_recurring | boolean | DEFAULT false | Recurring expense |
| is_paid | boolean | DEFAULT true | Payment status |
| payment_method | varchar | | Payment method |
| related_asset_id | uuid | FK ‚Üí assets | Related asset |
| related_supply_id | uuid | FK ‚Üí supplies | Related supply |
| quantity | integer | | Quantity purchased |
| auto_processed | boolean | DEFAULT false | Auto-processed flag |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `fixed_costs`
Recurring fixed cost definitions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| category | varchar | NOT NULL | Cost category |
| concept | varchar | NOT NULL | Cost concept/name |
| amount_cents | bigint | NOT NULL | Monthly amount in cents |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

---

### üì¶ Inventory Management

#### `supplies`
Dental supplies and materials inventory.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| name | text | NOT NULL | Supply name |
| category | varchar | NOT NULL, DEFAULT 'otros', CHECK | Category: insumo, bioseguridad, consumibles, materiales, medicamentos, equipos, otros |
| presentation | text | NOT NULL, DEFAULT '' | Package description |
| price_cents | bigint | NOT NULL | Purchase price in cents |
| portions | integer | NOT NULL, CHECK > 0 | Units per package |
| cost_per_portion_cents | integer | NOT NULL, DEFAULT 0 | Calculated unit cost |
| stock_quantity | integer | DEFAULT 0 | Current stock level |
| min_stock_alert | integer | DEFAULT 10 | Minimum stock threshold |
| last_purchase_price_cents | integer | | Last purchase price |
| last_purchase_date | date | | Last purchase date |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

#### `assets`
Capital assets and equipment.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| name | varchar | NOT NULL | Asset name |
| category | varchar | | Asset category |
| purchase_date | date | NOT NULL | Purchase date |
| purchase_price_cents | bigint | NOT NULL | Purchase price in cents |
| depreciation_years | integer | DEFAULT 3 | Useful life in years |
| depreciation_months | integer | DEFAULT (depreciation_years * 12) | Useful life in months |
| monthly_depreciation_cents | bigint | COMPUTED | Monthly depreciation amount |
| disposal_date | date | | Disposal/sale date |
| disposal_value_cents | bigint | | Disposal value |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**Computed Column:**
```sql
monthly_depreciation_cents =
  CASE
    WHEN depreciation_years IS NOT NULL AND depreciation_years > 0
    THEN purchase_price_cents / (depreciation_years * 12)
    ELSE NULL
  END
```

---

### üìä Marketing & Analytics

#### `patient_sources`
Patient acquisition source definitions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| name | varchar | NOT NULL | Source name |
| description | text | | Source description |
| is_active | boolean | DEFAULT true | Active status |
| is_system | boolean | DEFAULT false | System-defined source |
| color | varchar | | UI color |
| icon | varchar | | UI icon |
| created_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Creation timestamp |
| updated_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Update timestamp |

**Default Sources (created automatically):**
- direct
- referral
- social_media
- google
- website
- recommendation
- other

#### `marketing_campaigns`
Marketing campaign tracking.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| platform_category_id | uuid | FK ‚Üí categories, NOT NULL | Platform category |
| platform_id | uuid | FK ‚Üí categories | Specific platform |
| name | varchar | NOT NULL | Campaign name |
| code | varchar | | Campaign code |
| is_active | boolean | DEFAULT true | Active status |
| is_archived | boolean | DEFAULT false | Archived status |
| archived_at | timestamptz | | Archive date |
| reactivated_at | timestamptz | | Reactivation date |
| created_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Creation timestamp |
| updated_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Update timestamp |

#### `marketing_campaign_status_history`
Campaign status change log.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| campaign_id | uuid | FK ‚Üí marketing_campaigns, NOT NULL | Campaign |
| status | varchar | NOT NULL | New status |
| changed_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Change timestamp |

---

### üè∑Ô∏è Categories & Taxonomies

#### `category_types`
Category type definitions (meta-categories).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| name | varchar | NOT NULL, UNIQUE | Type identifier |
| display_name | varchar | NOT NULL | Display name |
| code | varchar | | Type code |
| description | text | | Type description |
| icon | varchar | | UI icon |
| color | varchar | | UI color |
| clinic_id | uuid | | Clinic (if clinic-specific) |
| is_system | boolean | DEFAULT false | System-defined type |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**Examples:**
- service_category
- expense_category
- marketing_platform

#### `custom_categories`
Clinic-specific category instances.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL | Owning clinic |
| category_type_id | uuid | FK ‚Üí category_types, NOT NULL | Category type |
| name | varchar | NOT NULL | Category identifier |
| display_name | varchar | NOT NULL | Display name |
| description | text | | Category description |
| color | varchar | | UI color |
| icon | varchar | | UI icon |
| sort_order | integer | DEFAULT 0 | Display order |
| is_active | boolean | DEFAULT true | Active status |
| is_system | boolean | DEFAULT false | System-defined |
| created_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Creation timestamp |
| updated_at | timestamptz | DEFAULT CURRENT_TIMESTAMP | Update timestamp |

**Auto-created categories for new clinics:**
- Service categories: preventive, restorative, endodontics

#### `categories`
Generic category table (used for various entities).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | | Owning clinic (optional) |
| category_type_id | uuid | FK ‚Üí category_types | Category type |
| entity_type | varchar | NOT NULL | Entity type (services, expenses, etc.) |
| name | varchar | NOT NULL | Category identifier |
| display_name | varchar | NOT NULL | Display name |
| code | varchar | | Category code |
| description | text | | Category description |
| icon | varchar | | UI icon |
| color | varchar | | UI color |
| parent_id | uuid | | Parent category (for hierarchies) |
| metadata | jsonb | DEFAULT '{}' | Additional metadata |
| display_order | integer | DEFAULT 999 | Display order |
| is_system | boolean | DEFAULT false | System-defined |
| is_active | boolean | DEFAULT true | Active status |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

---

### ‚öôÔ∏è Configuration

#### `settings_time`
Clinic time configuration for cost calculations.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| clinic_id | uuid | FK ‚Üí clinics, NOT NULL, UNIQUE | Owning clinic (one per clinic) |
| work_days | integer | DEFAULT 20 | Working days per month |
| hours_per_day | numeric | DEFAULT 7 | Working hours per day |
| real_pct | numeric | DEFAULT 80.00 | Utilization percentage |
| working_days_config | jsonb | DEFAULT complex | Working days configuration |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |
| updated_at | timestamptz | DEFAULT now() | Update timestamp |

**Default working_days_config:**
```json
{
  "manual": {
    "monday": true,
    "tuesday": true,
    "wednesday": true,
    "thursday": true,
    "friday": true,
    "saturday": true,
    "sunday": false
  },
  "detected": null,
  "useHistorical": true
}
```

---

### üìù Activity & Audit

#### `workspace_activity`
Audit log for workspace activities.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | PK | Primary key |
| workspace_id | uuid | FK ‚Üí workspaces, NOT NULL | Workspace |
| clinic_id | uuid | FK ‚Üí clinics | Related clinic |
| user_id | uuid | | User who performed action |
| user_email | varchar | | User email |
| action | varchar | NOT NULL | Action performed |
| entity_type | varchar | | Affected entity type |
| entity_id | uuid | | Affected entity ID |
| details | jsonb | DEFAULT '{}' | Additional details |
| created_at | timestamptz | DEFAULT now() | Action timestamp |

---

### üîê Authentication & Verification

#### `verification_codes`
Email verification codes for passwordless auth.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| email | text | PK | Email address |
| code | text | NOT NULL | Verification code |
| expires_at | timestamptz | NOT NULL | Expiration timestamp |
| used | boolean | DEFAULT false | Used flag |
| created_at | timestamptz | DEFAULT now() | Creation timestamp |

---

### üóëÔ∏è Backup & Legacy Tables

#### `_backup_patient_sources`
Backup of patient_sources (migration artifact).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | uuid | | Original ID |
| clinic_id | uuid | | Clinic ID |
| entity_type | varchar | | Entity type |
| name | varchar | | Source name |
| display_name | varchar | | Display name |
| is_system | boolean | | System flag |
| is_active | boolean | | Active flag |
| display_order | integer | | Display order |
| created_at | timestamptz | | Creation timestamp |

---

## Key Relationships

### Multi-Tenancy Flow
```
auth.users
  ‚Üí workspace_users ‚Üí workspaces
  ‚Üí clinics
  ‚Üí [patients, treatments, expenses, etc.]
```

### Financial Calculations
```
services + service_supplies ‚Üí variable_cost_cents
settings_time ‚Üí fixed_cost_per_minute_cents
services (margin_pct) ‚Üí price_cents
```

### Marketing Attribution
```
patient_sources ‚Üê patients ‚Üí marketing_campaigns
patients ‚Üí treatments (revenue)
```

---

## Important Business Rules

### 1. Money Storage
- **ALL** monetary values stored as `bigint` in **cents**
- Never use float/decimal for money storage
- Convert to currency format only in UI layer

### 2. Immutable Treatment Snapshots
Treatments store point-in-time snapshots of:
- `fixed_cost_per_minute_cents`
- `variable_cost_cents`
- `margin_pct`
- `price_cents`

These values NEVER change even if service prices change later.

### 3. Service Pricing Formula
```
variable_cost = SUM(service_supplies.qty * supply.cost_per_portion_cents)
time_cost = fixed_cost_per_minute_cents * est_minutes
total_cost = variable_cost + time_cost
price = total_cost * (1 + margin_pct/100)
```

### 4. RLS (Row Level Security)
- All tables with `clinic_id` have RLS policies
- Users can only access data from clinics they belong to
- Workspace owners have access to all clinics in their workspace

### 5. Auto-Created Data
When a new clinic is created, these are auto-created:
- Default patient_sources (7 sources)
- Default custom_categories (3 service categories)

---

## Recent Changes (Migration 41)

### Added Triggers
- `after_clinic_insert` ‚Üí Auto-creates patient_sources and custom_categories

### Modified Tables
- `custom_categories` ‚Üí Now used for service categorization
- `patient_sources` ‚Üí Standardized structure

---

## Schema Version History

| Version | Date | Migration | Description |
|---------|------|-----------|-------------|
| v1 | 2025-10-21 | 41 | Initial schema documentation |

---

## Notes

- This schema follows **strict separation** between configuration tables (`settings_time`, `fixed_costs`) and transactional tables (`treatments`, `expenses`)
- The category system is flexible and supports multiple entity types through `category_types` and `custom_categories`
- Marketing attribution is tracked through `patient_sources`, `marketing_campaigns`, and patient foreign keys
- All timestamps use `timestamptz` for proper timezone handling

